---
# Windows LDAP + Kerberos Role
# Sets up AD DS with LDAP and Kerberos services
# Note: AD DS includes both LDAP and Kerberos automatically

- name: Set DC hostname
  ansible.windows.win_hostname:
    name: "{{ dc_hostname }}"
  register: rename_result

- name: Reboot if hostname change requires it
  ansible.windows.win_reboot:
    msg: "Rebooting after hostname changes"
  when: rename_result.reboot_required

- name: Install Active Directory Domain Services (ADDS)
  ansible.windows.win_feature:
    name: AD-Domain-Services
    state: present
    include_management_tools: true
  register: ad_feature_result

- name: Reboot after ADDS feature install if needed
  ansible.windows.win_reboot:
    msg: "Rebooting after ADDS feature install"
  when: ad_feature_result.reboot_required | default(false)

- name: Create AD domain and reboot
  microsoft.ad.domain:
    dns_domain_name: "{{ domain_name }}"
    domain_netbios_name: "{{ netbios_name }}"
    safe_mode_password: "{{ safe_mode_password }}"
    create_dns_delegation: false
    install_dns: false
    reboot: true
  register: domain_create
  when: not join_domain | default(false)

- name: Reboot after domain creation / DC promotion if needed
  ansible.windows.win_reboot:
    msg: "Rebooting after domain creation / DC promotion"
  when:
    - not join_domain | default(false)
    - domain_create.reboot_required | default(true)

- name: Verify LDAP service is running
  ansible.windows.win_service:
    name: NTDS
    state: started

- name: Verify Kerberos Key Distribution Center is running
  ansible.windows.win_service:
    name: KDC
    state: started

---
-  name: Install and configure Grafana
   hosts: clients
   become: true

# Variables are now centralized in group_vars/all.yml
# Reference: applications.grafana.*
# Override only if needed for this specific deployment

#Mains task to insrall and configure grafana
   tasks:
    - name: Install prerequisite packages
      apt:
        name:
          - apt-transport-https
          - software-properties-common
          - wget
          - gnupg
        state: present
        update_cache: true
#add grafana GPG for package verfication
    - name: Add Grafana GPG key
      apt_key:
        url: https://apt.grafana.com/gpg.key
        state: present
#add grafana Repo
    - name: Add Grafana APT repository
      apt_repository:
        repo: "deb https://apt.grafana.com stable main"
        state: present
        filename: grafana
#Install grafana Repository
    - name: Install Grafana
      apt:
        name: grafana
        state: present
        update_cache: true

#configure basic Grafan setting suck as port and domain
    - name: Configure grafana.ini (minimal settings)
      lineinfile:
        path: /etc/grafana/grafana.ini
        regexp: "^;?{{ item.key }} ="
        line: "{{ item.key }} = {{ item.value }}"
        backrefs: false
      loop:
        - { key: "http_port", value: "{{ applications.grafana.http_port }}" }
        - { key: "domain", value: "{{ applications.grafana.domain }}" }
        - { key: "root_url", value: "{{ applications.grafana.root_url }}" }
        - { key: "admin_user", value: "{{ applications.grafana.admin_user }}" }
        - { key: "admin_password", value: "{{ applications.grafana.admin_password }}" }
      notify: Restart grafana

#ENsure Grafan service is enabled and running 
    - name: Ensure Grafana is enabled and running
      systemd:
        name: grafana-server
        enabled: true
        state: started

   handlers:
    - name: Restart grafana
      systemd:
        name: grafana-server
        state: restarted

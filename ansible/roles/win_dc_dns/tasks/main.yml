---
# Windows Domain Controller + DNS Role
# Installs AD DS, DNS, creates domain, OU, group, and user

- name: Set DC hostname
  ansible.windows.win_hostname:
    name: "{{ dc_hostname }}"
  register: rename_result

- name: Reboot if hostname change requires it
  ansible.windows.win_reboot:
    msg: "Rebooting after hostname changes"
  when: rename_result.reboot_required

- name: Install Active Directory Domain Services (ADDS)
  ansible.windows.win_feature:
    name: AD-Domain-Services
    state: present
    include_management_tools: "{{ install_management_tools }}"
  register: ad_feature_result

- name: Install DNS
  ansible.windows.win_feature:
    name: DNS
    state: present
    include_management_tools: "{{ install_management_tools }}"
  register: dns_feature_result

- name: Reboot after ADDS/DNS feature install if needed
  ansible.windows.win_reboot:
    msg: "Rebooting after ADDS/DNS feature install"
  when: (ad_feature_result.reboot_required | default(false)) or (dns_feature_result.reboot_required | default(false))

- name: Create AD domain and reboot
  microsoft.ad.domain:
    dns_domain_name: "{{ domain_name }}"
    domain_netbios_name: "{{ domain_netbios_name }}"
    safe_mode_password: "{{ safe_mode_password }}"
    create_dns_delegation: "{{ dns_create_delegation }}"
    install_dns: "{{ dns_install }}"
    reboot: true
  register: domain_create

- name: Reboot after domain creation / DC promotion if needed
  ansible.windows.win_reboot:
    msg: "Rebooting after domain creation / DC promotion"
  when: domain_create.reboot_required | default(true)

- name: Build domain DN path
  set_fact:
    domain_dn: "DC={{ domain_name.split('.') | join(',DC=') }}"

- name: Create OU
  microsoft.ad.ou:
    name: "{{ ou_name }}"
    path: "{{ domain_dn }}"
    state: present

- name: Create group in OU
  microsoft.ad.group:
    name: "{{ group_name }}"
    path: "OU={{ ou_name }},{{ domain_dn }}"
    scope: global
    state: present

- name: Create user in OU
  microsoft.ad.user:
    name: "{{ domain_user.sam }}"
    firstname: "{{ domain_user.given }}"
    lastname: "{{ domain_user.surname }}"
    password: "{{ domain_user.password }}"
    path: "OU={{ ou_name }},{{ domain_dn }}"
    enabled: true
    state: present

- name: Add user to group
  ansible.windows.win_powershell:
    script: |
      Import-Module ActiveDirectory
      Add-ADGroupMember -Identity "{{ group_name }}" -Members "{{ domain_user.sam }}" -ErrorAction SilentlyContinue
